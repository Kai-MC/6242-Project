<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>US Accident Map 2020</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f8f8f8;
    }
    #controls {
      padding: 10px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    #map {
      display: block;
      margin: auto;
    }
    .tooltip {
      position: absolute;
      padding: 6px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      font-size: 14px;
    }
    label {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div id="sliders"></div>
    <div id="dropdowns"></div>
  </div>
  <svg id="map" width="960" height="600"></svg>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script>
    const svg = d3.select("#map"),
          width = +svg.attr("width"),
          height = +svg.attr("height");

    const state_lookup = { 
      "New Jersey": "NJ",
      "New York": "NY",
      "Pennsylvania": "PA",
      "Virginia": "VA",
      "North Carolina": "NC",
      "Georgia": "GA",
      "Florida": "FL",
      "Alabama": "AL",  
      "Mississippi": "MS",
      "Louisiana": "LA",
      "Texas": "TX",
      "Arkansas": "AR",
      "Tennessee": "TN",
      "Kentucky": "KY",
      "Ohio": "OH",
      "Indiana": "IN",
      "Illinois": "IL",
      "Missouri": "MO",
      "Iowa": "IA",
      "Nebraska": "NE",
      "South Dakota": "SD",
      "North Dakota": "ND",
      "Montana": "MT",
      "Wyoming": "WY",
      "Colorado": "CO",
      "Utah": "UT",
      "Idaho": "ID",
      "Washington": "WA",
      "Oregon": "OR",
      "California": "CA",
      "Nevada": "NV",
      "Arizona": "AZ",
      "New Mexico": "NM",
      "Alaska": "AK",
      "Hawaii": "HI",
      "Maine": "ME",
      "New Hampshire": "NH",
      "Vermont": "VT",
      "Massachusetts": "MA",
      "Rhode Island": "RI",
      "Connecticut": "CT",
      "Delaware": "DE",
      "Maryland": "MD",
      "West Virginia": "WV",
      "District of Columbia": "DC",
      "South Carolina": "SC",
      "Oclahoma": "OK",
      "Wisconsin": "WI",
      "Michigan": "MI",
    }; // State fullname to abbreviation mapping

    const projection = d3.geoAlbersUsa().scale(1000).translate([width / 2, height / 2]);
    const path = d3.geoPath().projection(projection);

    const tooltip = d3.select("body").append("div").attr("class", "tooltip");

    let originalData;
    const stateStats = new Map();

    Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
      d3.csv("us_accident_2020.csv")
    ]).then(([us, data]) => {
      data.forEach(d => {
        d.Lat = +d["Start_Lat"];
        d.Lng = +d["Start_Lng"];
        d.Severity = +d["Severity"];
        d.Temperature = +d["Temperature(F)"];
        d.Humidity = +d["Humidity(%)"];
        d.Visibility = +d["Visibility(mi)"];
        d.Pressure = +d["Pressure(in)"];
        d.State = d["State"];
        d.Landscape = JSON.parse(d["Landscape"].replace(/'/g, '"'));
        d.Date = new Date(d["Start_Time"]);
        d.Month = d.Date.getFullYear() + "-" + String(d.Date.getMonth() + 1).padStart(2, '0');
      });

      originalData = data;

      updateStateStats(originalData);

      drawMap(us, stateStats);
      createMonthSelector(data);
      createSliders(data);
      // createDropdown(data);
      createCheckboxes(data);

      const latestMonth = d3.max(data, d => d.Month);
      d3.select("#monthSelector").property("value", latestMonth);
      filterData();
      
    });

    function drawMap(us, stateStats) {
      svg.append("g")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.states).features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", "#eee")
        .attr("stroke", "#999")
        .on("mouseover", function (event, d) {
          var stateCode = state_lookup[d.properties.name];
          var stat = stateStats.get(stateCode);
          if (stat) {
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip.html(`
              <strong>${stateCode}</strong><br/>
              Accidents: ${stat.count}<br/>
              Avg Severity: ${stat.avgSeverity}
            `);
          }
        })
        .on("mousemove", event => {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", () => tooltip.transition().duration(300).style("opacity", 0));
    }

    function drawPoints(data) {
      const colorScale = d3.scaleSequential(d3.interpolateOrRd).domain([1, 4]);
      svg.selectAll("circle").remove();

      svg.selectAll("circle")
        .data(data.filter(d => projection([d.Lng, d.Lat])))
        .enter().append("circle")
        .attr("cx", d => projection([d.Lng, d.Lat])[0])
        .attr("cy", d => projection([d.Lng, d.Lat])[1])
        .attr("r", 1)
        .attr("fill", d => colorScale(d.Severity))
        .attr("opacity", 0.6);
    }

    function createSliders(data) {
      const tempExtent = d3.extent(data, d => d.Temperature);
      const humExtent = d3.extent(data, d => d.Humidity);
      const visExtent = d3.extent(data, d => d.Visibility);
      const pressureExtent = d3.extent(data, d => d.Pressure);

      d3.select("#sliders").html("");

      createSlider("Temperature", tempExtent);
      createSlider("Humidity", humExtent);
      createSlider("Visibility", visExtent);
      createSlider("Pressure", pressureExtent);
    }

    function createSlider(label, extent, us) {
      const container = d3.select("#sliders").append("div");
      container.append("label").text(label);

      container.append("input")
        .attr("type", "range")
        .attr("min", extent[0])
        .attr("max", extent[1])
        .attr("value", extent[1])
        .attr("step", 1)
        .attr("id", label)
        .on("input", filterData);
    }

    // function createDropdown(data, us) {
    //   console.log(data);
    //   const values = Array.from(new Set(
    //     data.flatMap(d => (d.Landscape.length > 0)
    //       ? d.Landscape
    //       : ["None"]
    //   )));
    //   const dropdown = d3.select("#dropdowns").append("select").attr("id", "landscapeSelector").on("change", filterData);
    //   dropdown.append("option").text("All");
    //   dropdown.selectAll("option.value")
    //     .data(values)
    //     .enter().append("option")
    //     .text(d => d);
    // }
    function createCheckboxes(data, us) {
      const values = Array.from(new Set(
        data.flatMap(d => (Array.isArray(d.Landscape) && d.Landscape.length > 0)
          ? d.Landscape
          : ["None"]
      )));

      const container = d3.select("#dropdowns").append("div").attr("id", "landscapeCheckboxes");

      values.forEach(val => {
        const label = container.append("label").style("margin-right", "10px");
        label.append("input")
          .attr("type", "checkbox")
          .attr("value", val)
          .property("checked", val === "None")  // 默认选中
          .on("change", filterData);  // 每次更改时触发
        label.append("span").text(val);
      });
    }

    function createMonthSelector(data, us) {
      const monthList = Array.from(new Set(data.map(d => d.Month))).sort();
      const dropdown = d3.select("#dropdowns")
        .append("select")
        .attr("id", "monthSelector")
        .on("change", filterData);

      dropdown.selectAll("option")
        .data(monthList)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);
    }

    function updateStateStats(filtered) {
      stateStats.clear();
      const tempMap = d3.rollup(
        filtered,
        v => ({
          count: v.length,
          avgSeverity: d3.mean(v, d => d.Severity).toFixed(2)
        }),
        d => d.State
      );

      for (const [key, value] of tempMap.entries()) {
        stateStats.set(key, value);
      }
    }

    function rowMatches(d, selected) {
      // empty - nothing selected
      if (selected.length === 0) return false;

      const hasNone = selected.includes("None");
      const hasOthers = selected.some(l => l !== "None");

      // Landscape 是空数组
      if (!d.Landscape || d.Landscape.length === 0) {
        return hasNone;
      }

      // Landscape 有值
      if (hasOthers) {
        return d.Landscape.some(l => selected.includes(l));
      }

      return false;
    }

    function filterData() {
      const tempMax = +d3.select("#Temperature").property("value");
      const humMax = +d3.select("#Humidity").property("value");
      const visMax = +d3.select("#Visibility").property("value");
      const pressureMax = +d3.select("#Pressure").property("value");
      const landscapes = Array.from(
        d3.selectAll("#landscapeCheckboxes input:checked").nodes()
      ).map(d => d.value);
      const selectedMonth = d3.select("#monthSelector").property("value");

      const filtered = originalData.filter(d =>
        d.Month === selectedMonth &&
        d.Temperature <= tempMax &&
        d.Humidity <= humMax &&
        d.Visibility <= visMax &&
        d.Pressure <= pressureMax &&
        rowMatches(d, landscapes)
      );

      console.log(filtered);

      updateStateStats(filtered);

      drawPoints(filtered);
    }
  </script>
</body>
</html>
